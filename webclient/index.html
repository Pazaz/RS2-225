<!DOCTYPE html>
<html>
    <head>
        <title>RuneScape 2</title>

        <script src="https://unpkg.com/pcm-player"></script>

        <script>
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioCtx = new AudioContext();
    
            function playWave(data, vol) {
                try {
                    audioCtx.decodeAudioData(Uint8Array.from(data).buffer).then(buffer => {
                        var track = audioCtx.createBufferSource();
                        track.buffer = buffer;
                        track.connect(audioCtx.destination);
                        track.start(0);
                    });
                } catch (err) {
                    // console.log(err);
                }
            }

            function setWaveVolume(vol) {
                console.log(vol);
            }

            let player = undefined;
            function playMidi(data, vol) {
                if (player) {
                    player.pause();
                    player.destroy();
                }

                player = new PCMPlayer({
                    inputCodec: 'Int16',
                    channels: 2,
                    sampleRate: 22050
                });
                player.volume(vol / 256);

                if (window.tinyMidiPCM) {
                    const pcm = tinyMidiPCM.render(data);
                    if (pcm.length > 0) {
                        player.feed(pcm);
                    }
                }
            }

            function setMidiVolume(vol) {
                if (player) {
                    player.volume(vol / 256);
                }
            }

            function stopMidi() {
                if (player) {
                    player.pause();
                    player.destroy();
                }
            }
        </script>

        <script type="text/javascript" charset="utf-8" src="target/js/classes.js"></script>

        <script type="module">
            import TinyMidiPCM from './index.js';

            (async () => {
                const tinyMidiPCM = new TinyMidiPCM();

                await tinyMidiPCM.init();

                const soundfontRes = await fetch('/gm.sf2');

                const soundfontBuffer = new Uint8Array(
                    await soundfontRes.arrayBuffer()
                );

                tinyMidiPCM.setSoundfont(soundfontBuffer);

                window.tinyMidiPCM = tinyMidiPCM;

                window.main();
            })();
        </script>
    </head>

    <body style="background-color: black">
        <canvas id="game" width="789" height="532"></canvas>
    </body>
</html>
